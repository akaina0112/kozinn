<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>èª•ç”Ÿæ—¥ã¨å¹´é½¢è¡¨ç¤º</title>
  <style>
    @font-face {
      font-family: 'PixelMplus';
      src: url('https://akaina0809.github.io/error/PixelMplus12-Regular.ttf') format('truetype');
    }

    body {
      font-family: 'PixelMplus', sans-serif;
      text-align: center;
      margin-top: 40px;
      background-size: cover;
      transition: background-image 1s ease;
    }

    #clock {
      font-size: 2em;
      margin-bottom: 20px;
    }

    input, button {
      font-size: 1em;
      margin: 5px;
      padding: 5px;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      margin-bottom: 8px;
    }

    .sakura {
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/6/6b/Sakura_tree_in_full_bloom.jpg');
    }
  </style>
</head>
<body>
  <h1>ç¾åœ¨ã®æ™‚åˆ»</h1>
  <div id="clock">èª­ã¿è¾¼ã¿ä¸­...</div>

  <div>
    <h2>èª•ç”Ÿæ—¥ã‚’ç™»éŒ²ï¼ˆYYYY/MM/DDï¼‰</h2>
    <input type="text" id="nameInput" placeholder="åå‰">
    <input type="text" id="birthInput" placeholder="ä¾‹: 2000/05/25">
    <button onclick="addBirthday()">è¿½åŠ </button>
  </div>

  <div>
    <h2>ç™»éŒ²ä¸€è¦§ï¼ˆèª•ç”Ÿæ—¥ãŒè¿‘ã„é †ï¼‰</h2>
    <ul id="birthdayList"></ul>
  </div>

<script>
  function loadBirthdays() {
    return JSON.parse(localStorage.getItem('birthdays') || '[]');
  }

  function saveBirthdays(data) {
    localStorage.setItem('birthdays', JSON.stringify(data));
  }

  function addBirthday() {
    const name = document.getElementById('nameInput').value.trim();
    const birth = document.getElementById('birthInput').value.trim();
    if (!name || !/^\d{4}\/\d{2}\/\d{2}$/.test(birth)) {
      alert("åå‰ã¨èª•ç”Ÿæ—¥ï¼ˆYYYY/MM/DDï¼‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    const data = loadBirthdays();
    data.push({ name, birth });
    saveBirthdays(data);
    document.getElementById('nameInput').value = '';
    document.getElementById('birthInput').value = '';
    renderBirthdays();
  }

  function calculateAge(fullBirth, now) {
    const [by, bm, bd] = fullBirth.split('/').map(Number);
    let age = now.getFullYear() - by;
    const birthdayThisYear = new Date(now.getFullYear(), bm - 1, bd);
    if (now < birthdayThisYear) age--;
    return age;
  }

  function daysUntilNextBirthday(fullBirth, now) {
    const [, bm, bd] = fullBirth.split('/').map(Number);
    const thisYear = now.getFullYear();
    const birthdayThisYear = new Date(thisYear, bm - 1, bd);
    if (birthdayThisYear < now) {
      birthdayThisYear.setFullYear(thisYear + 1);
    }
    const diff = birthdayThisYear - now;
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  }

  function renderBirthdays() {
    const now = new Date();
    const list = document.getElementById('birthdayList');
    const data = loadBirthdays();

    data.sort((a, b) => {
      return daysUntilNextBirthday(a.birth, now) - daysUntilNextBirthday(b.birth, now);
    });

    let isBirthdayToday = false;

    list.innerHTML = '';
    data.forEach((person, index) => {
      const age = calculateAge(person.birth, now);
      const daysLeft = daysUntilNextBirthday(person.birth, now);
      const li = document.createElement('li');

      if (daysLeft === 0) isBirthdayToday = true;

      li.textContent = `${person.name}ï¼š${age}æ­³ï¼ˆã‚ã¨${daysLeft}æ—¥ï¼‰`;

      const del = document.createElement('button');
      del.textContent = 'å‰Šé™¤';
      del.onclick = () => {
        const updated = [...data];
        updated.splice(index, 1);
        saveBirthdays(updated);
        renderBirthdays();
      };

      li.appendChild(del);
      list.appendChild(li);
    });

    document.body.classList.toggle('sakura', isBirthdayToday);
  }

  function updateClock() {
    const now = new Date();
    const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    const w = days[now.getDay()];
    const h = String(now.getHours()).padStart(2, '0');
    const min = String(now.getMinutes()).padStart(2, '0');
    const s = String(now.getSeconds()).padStart(2, '0');

    document.getElementById('clock').textContent = `${y}/${m}/${d}(${w}) ${h}:${min}:${s}`;
    renderBirthdays();
  }

  // âœ… URLã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€ï¼ˆ?data=...ï¼‰
  function loadFromURL() {
    const params = new URLSearchParams(window.location.search);
    const raw = params.get('data');
    if (raw) {
      try {
        const decoded = decodeURIComponent(raw);
        const json = JSON.parse(decoded);
        if (Array.isArray(json)) {
          saveBirthdays(json);
          alert("å…±æœ‰ã•ã‚ŒãŸèª•ç”Ÿæ—¥ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
        }
      } catch (e) {
        alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå½¢å¼ãŒä¸æ­£ï¼‰");
      }
    }
  }

  // âœ… ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’URLã¨ã—ã¦å‡ºåŠ›
  function shareURL() {
    const data = loadBirthdays();
    const encoded = encodeURIComponent(JSON.stringify(data));
    const url = `${location.origin}${location.pathname}?data=${encoded}`;
    prompt("ã“ã®URLã‚’å…±æœ‰ã—ã¦ãã ã•ã„:", url);
  }

  // ğŸ“ å…±æœ‰ãƒœã‚¿ãƒ³ã‚’è‡ªå‹•è¿½åŠ 
  window.addEventListener('DOMContentLoaded', () => {
    const btn = document.createElement('button');
    btn.textContent = 'è¨­å®šã‚’å…±æœ‰ï¼ˆURLç”Ÿæˆï¼‰';
    btn.onclick = shareURL;
    document.body.appendChild(btn);

    loadFromURL();
    renderBirthdays();
    updateClock();
    setInterval(updateClock, 1000);
  });
</script>
</body>
</html>