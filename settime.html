<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>誕生日時計</title>

  <style>
    @font-face {
      font-family: 'PixelMplus';
      src: url('https://akaina0809.github.io/error/PixelMplus12-Regular.ttf') format('truetype');
    }

    body {
      font-family: 'PixelMplus', sans-serif;
      text-align: center;
      margin-top: 40px;
      font-size: 1.2em;
      background-size: cover;
      background-repeat: no-repeat;
      transition: background-image 1s ease;
    }

    #clock {
      font-size: 2em;
      margin-bottom: 20px;
      font-weight: bold;
    }

    #birthdayForm input {
      font-size: 1em;
      margin: 5px;
      padding: 5px;
    }

    #birthdayForm button {
      font-size: 1em;
      padding: 5px 10px;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      margin-bottom: 8px;
    }

    .sakura {
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/6/6b/Sakura_tree_in_full_bloom.jpg');
    }
  </style>
</head>
<body>
  <h1>現在の時刻</h1>
  <div id="clock">読み込み中...</div>

  <div id="birthdayForm">
    <h2>誕生日を登録</h2>
    <input type="text" id="nameInput" placeholder="名前">
    <input type="text" id="birthInput" placeholder="MM/DD">
    <button onclick="addBirthday()">追加</button>
  </div>

  <div>
    <h2>登録された誕生日（近い順）</h2>
    <ul id="birthdayList"></ul>
  </div>

  <script>
    function loadBirthdays() {
      return JSON.parse(localStorage.getItem('birthdays') || '[]');
    }

    function saveBirthdays(data) {
      localStorage.setItem('birthdays', JSON.stringify(data));
    }

    function addBirthday() {
      const name = document.getElementById('nameInput').value.trim();
      const birth = document.getElementById('birthInput').value.trim();

      if (!name || !/^\d{2}\/\d{2}$/.test(birth)) {
        alert("名前と誕生日（MM/DD形式）を入力してください");
        return;
      }

      const data = loadBirthdays();
      data.push({ name, birth });
      saveBirthdays(data);
      document.getElementById('nameInput').value = '';
      document.getElementById('birthInput').value = '';
      renderBirthdays();
    }

    function calculateAge(birthMD, now) {
      const birthDate = new Date(`${now.getFullYear()}/${birthMD}`);
      const thisYear = now.getFullYear();
      const birthYear = birthDate > now ? thisYear - 1 : thisYear;
      return birthYear ? thisYear - birthYear : 0;
    }

    function daysUntilNextBirthday(birthMD, now) {
      const [mm, dd] = birthMD.split('/').map(Number);
      const next = new Date(now.getFullYear(), mm - 1, dd);
      if (next < now) {
        next.setFullYear(next.getFullYear() + 1);
      }
      const diff = Math.ceil((next - now) / (1000 * 60 * 60 * 24));
      return diff;
    }

    function renderBirthdays() {
      const now = new Date();
      const list = document.getElementById('birthdayList');
      let birthdays = loadBirthdays();

      // 今日が誕生日の人がいれば背景を桜に
      let isBirthdayToday = false;

      // 日数ソート
      birthdays.sort((a, b) => {
        return daysUntilNextBirthday(a.birth, now) - daysUntilNextBirthday(b.birth, now);
      });

      list.innerHTML = '';
      birthdays.forEach((entry, index) => {
        const age = calculateAge(entry.birth, now);
        const days = daysUntilNextBirthday(entry.birth, now);
        const li = document.createElement('li');

        if (days === 0) isBirthdayToday = true;

        li.textContent = `${entry.name}：${age}歳（あと${days}日）`;

        const del = document.createElement('button');
        del.textContent = '削除';
        del.onclick = () => {
          const updated = [...birthdays];
          updated.splice(index, 1);
          saveBirthdays(updated);
          renderBirthdays();
        };
        li.appendChild(del);
        list.appendChild(li);
      });

      document.body.classList.toggle('sakura', isBirthdayToday);
    }

    function updateClock() {
      const now = new Date();
      const days = ['日', '月', '火', '水', '木', '金', '土'];
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const day = days[now.getDay()];
      const h = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');

      document.getElementById('clock').textContent = `${y}/${m}/${d}(${day}) ${h}:${min}:${s}`;

      renderBirthdays();
    }

    renderBirthdays();
    updateClock();
    setInterval(updateClock, 1000);
  </script>
</body>
</html>